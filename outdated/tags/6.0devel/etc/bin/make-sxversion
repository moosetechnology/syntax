#!/bin/sh

# This script is used by two types of makefiles :
# - the "autotools" makefiles, generated by the configure script
# - the "old" makefiles, available only with a subversion checkout
#
# This script creates the file $1/incl/sxversion.h, which
# #defines theses 2 directives : SXVERSION, SX_COMPILE_DATE, and 
# the variable release_mess
# It also updates syntax.m4 (variable syntaxversion)


TOPDIR=$1
OUTPUT_FILE=$TOPDIR/incl/sxversion.h
SYNTAX_M4_FILE=$TOPDIR/syntax.m4

SXVERSION=`grep AC_INIT $TOPDIR/configure.ac|cut -d, -f2|sed 's+ ++g'`

echo '#ifndef SVNVERSION' > $OUTPUT_FILE

if [ -r $TOPDIR/vasy/force-svnversion ]
then
   # la variable $SVNVERSION est imposee de force
   SVNVERSION=`cat $TOPDIR/vasy/force-svnversion`
   echo '#define SVNVERSION " (revision '$SVNVERSION')"' >> $OUTPUT_FILE
elif [ -x "/usr/bin/svnversion" ]
then
    # the command svnversion is available
    SVNVERSION=`svnversion $TOPDIR`
    echo '#define SVNVERSION " (revision '$SVNVERSION')"' >> $OUTPUT_FILE
else
    # the command svnversion is not available
    if [ -x "/common/com/Make-mach" ]
    then
	# we are on a machine from the Team Vasy, and we can launch the 
	# svnversion command by remote ssh:
        SVNVERSION_MACHINE=`/common/com/Make-mach iX86`
	SVNVERSION=`ssh $SVNVERSION_MACHINE "svnversion $TOPDIR"`
	echo '#define SVNVERSION " (revision '$SVNVERSION')"' >> $OUTPUT_FILE
    else
	echo '#define SVNVERSION ""' >> $OUTPUT_FILE
    fi
fi    
echo '#endif /* SVNVERSION */' >> $OUTPUT_FILE
echo '#ifndef SXVERSION' >> $OUTPUT_FILE
echo '#define SXVERSION "'$SXVERSION'"' >> $OUTPUT_FILE
echo '#endif /* SXVERSION */' >> $OUTPUT_FILE
echo '#ifndef SX_COMPILE_DATE' >> $OUTPUT_FILE
sh -c "echo '#define SX_COMPILE_DATE \"`date`\"' >> $OUTPUT_FILE"
echo '#endif /* SX_COMPILE_DATE */' >> $OUTPUT_FILE
echo '#ifndef SX_release_mess' >> $OUTPUT_FILE
echo '#ifdef SX_DFN_EXT_VAR' >> $OUTPUT_FILE
echo 'char	release_mess [] = "Release " SXVERSION SVNVERSION " of Date " SX_COMPILE_DATE ;' >> $OUTPUT_FILE
echo '#else' >> $OUTPUT_FILE
echo 'extern char	release_mess [];' >> $OUTPUT_FILE
echo '#endif /* SX_DFN_EXT_VAR */' >> $OUTPUT_FILE
echo '#define SX_release_mess' >> $OUTPUT_FILE
echo '#endif /* SX_release_mess */' >> $OUTPUT_FILE

perl -i -pe "s/syntaxversion=\".*?\"/syntaxversion=\"$SXVERSION\"/" $SYNTAX_M4_FILE;
