      SUBROUTINE FITFUN(FONCT,NERR,NB_COEFF,NVAR,NPOINT,NW,COEF,X,Y,W,
     &  EPS0,EPS1,VARF,VARF1,NIT,INTP,NINV,NCIT)
c -------+---------+---------+---------+---------+---------+---------+--
      IMPLICIT REAL*8 (A-H,O-Z)
      EXTERNAL FONCT
      DIMENSION COEF(NB_COEFF),X(NVAR,NPOINT),Y(NPOINT),W(NPOINT)
      REAL*8 EPS0,EPS1,VARF,VARF1
      INTEGER NIT,INTP,NINV,NCIT
C
      DIMENSION TB(10),DERIVE(10)
      EQUIVALENCE (TB,B),(BB,DERIVE)
C
      CHARACTER*8 NONCHG,ICAR,LINTST
      LOGICAL LINEAR
C
      DATA NONCHG / 'NONCHANGE' /
C
      NERR=1
      IF (NIT  .LE. 0)  NIT  = 500
      IF (EPS0 .LE. 0.) EPS0 = 0.1
      IF (EPS1 .LE. 0.) EPS1 = 0.001
      LINTST=NONCHG
      CALL FONCT(NB_COEFF,NVAR,X,COEF,  LINTST  ,DERIVE)
      LINEAR=LINTST.EQ.NONCHG
C
      DO 210 N=1,NIT
      NCIT=N
      VNUL=0.0
      CALL INID(B,VNUL,10)
      CALL INID(A,VNUL,100)
      DO 40 JAY=1,NPOINT
      YC=0.
      CALL FONCT( NB_COEFF,NVAR,X(1,JAY),COEF,YC,DERIVE )
      F1=Y(JAY)-YC
      WI=1.0
      IF(LINEAR.AND.NW.EQ.3) YC=ACCUM2(COEF,DERIVE,NB_COEFF)
      IF(NW.GT.0) CALL POIDS ( NW,Y(JAY),YC,W(JAY),WI )
      DO 30 L=1,NB_COEFF
      B(L)=B(L)+DERIVE(L)*F1*WI
      DO 30 M=L,NB_COEFF
   30 A(L,M)=A(L,M)+DERIVE(L)*DERIVE(M)*WI
   40 CONTINUE
C
      DO 50 M=2,NB_COEFF
      K=M-1
      DO 50 I=1,K
   50 A(M,I)=A(I,M)
      CALL DETER (A,NB_COEFF,DET)
      CALL INVER (C,NB_COEFF,10,NERR,200)
   80 CONTINUE
      DO 90 J=1,NB_COEFF
      BB(J)= 0.0
      DO 90 I=1,NB_COEFF
   90 BB(J)= C(J,I)*B(I) + BB(J)
      IF (.NOT.LINEAR) GO TO 120
      DO 110 I=1,NB_COEFF
  110 COEF(I)=B(I)
      GO TO 240
C
  120 CONTINUE
      IF(EPS1.NE.0.0) GO TO 140
C
      DO 130 I=1,NB_COEFF
  130 TB(I)=COEF(I)+B(I)
      GO TO 170
  140 CONTINUE
      DO 160 I=1,NB_COEFF
      ARG=EPS1*COEF(I)
      IF( ABS(ARG) .GE. ABS(B(I))) GO TO 150
      GO TO 160
  150 TB(I)=COEF(I)+B(I)
  160 CONTINUE
C
  170 CONTINUE
      DO 180 I=1,NB_COEFF
      CONV= ABS(COEF(I)/TB(I)-1.0)
  180 CONTINUE
      NERR=3
  210 CONTINUE
C
  240 CONTINUE
      SUMW=0.0
      VARF=0.0
      ERMAX=0.
      DO 250 JAY=1,NPOINT
      CALL FONCT( NB_COEFF,NVAR,X(1,JAY),COEF,YC,DERIVE )
      IF(LINEAR) YC=ACCUM2 (COEF,DERIVE,NB_COEFF)
      F1=Y(JAY)-YC
      WI=1.0
      IF(NW.GT.0) CALL POIDS ( NW,Y(JAY),YC,W(JAY),WI )
      VARF=VARF+WI*F1**2
      F1=ABS(F1)
      ERMAX=F1
      JMAX=JAY
  250 SUMW=SUMW+WI
C
      VARF=VARF/(FLOAT (NPOINT)-FLOAT (NB_COEFF))
      VARF1=VARF/SUMW
      RETURN
      END
